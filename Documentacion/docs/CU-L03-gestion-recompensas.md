# CU-L03: Gestión de Recompensas (Catálogo y Canje)

## Diagrama de Secuencia

![Diagrama de Secuencia](secuencia-gestion-recompensas.puml)

## Especificación del Caso de Uso

| **Campo**                                | **Descripción**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| ---------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **ID**                                   | CU-L03                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **Nombre**                               | Gestión de Recompensas (Catálogo y Canje)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **Actor Principal**                      | Cliente                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Descripción**                          | Permite al cliente explorar el catálogo de recompensas disponibles según su nivel y canjear recompensas por cupones de descuento utilizando sus puntos acumulados                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **Precondiciones**                       | - El cliente debe estar autenticado<br>- El cliente debe tener una cuenta de lealtad<br>- Debe haber recompensas activas en el sistema                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **Postcondiciones**                      | - El cliente visualiza recompensas disponibles para su nivel<br>- Si canjea: puntos deducidos, cupón generado, stock actualizado<br>- Transacción y canje registrados en el historial                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **Flujo Principal - Ver Catálogo**       | 1. El cliente accede a "Recompensas" (`/loyalty/rewards`)<br>2. El sistema carga la cuenta del cliente<br>3. El sistema filtra recompensas:<br>&nbsp;&nbsp;&nbsp;- Solo recompensas activas<br>&nbsp;&nbsp;&nbsp;- Solo niveles <= nivel del cliente<br>&nbsp;&nbsp;&nbsp;- Con stock disponible<br>4. El sistema muestra cada recompensa con:<br>&nbsp;&nbsp;&nbsp;- Imagen de la recompensa<br>&nbsp;&nbsp;&nbsp;- Nombre y descripción<br>&nbsp;&nbsp;&nbsp;- Tipo (descuento %, descuento fijo, producto gratis)<br>&nbsp;&nbsp;&nbsp;- Valor del descuento<br>&nbsp;&nbsp;&nbsp;- Costo en puntos<br>&nbsp;&nbsp;&nbsp;- Nivel mínimo requerido<br>&nbsp;&nbsp;&nbsp;- Stock disponible (si aplica)<br>&nbsp;&nbsp;&nbsp;- Botón "Canjear" (habilitado/deshabilitado)<br>5. El sistema muestra puntos disponibles del cliente en la parte superior                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Flujo Principal - Canjear Recompensa** | 1. El cliente hace clic en "Canjear" de una recompensa<br>2. El sistema muestra modal de confirmación con:<br>&nbsp;&nbsp;&nbsp;- Detalles de la recompensa<br>&nbsp;&nbsp;&nbsp;- Puntos a gastar<br>&nbsp;&nbsp;&nbsp;- Puntos restantes después del canje<br>3. El cliente confirma el canje<br>4. El sistema inicia transacción de base de datos<br>5. El sistema valida:<br>&nbsp;&nbsp;&nbsp;- Recompensa está activa<br>&nbsp;&nbsp;&nbsp;- Cliente tiene nivel suficiente<br>&nbsp;&nbsp;&nbsp;- Cliente tiene puntos suficientes<br>&nbsp;&nbsp;&nbsp;- Hay stock disponible<br>6. El sistema deduce los puntos<br>7. El sistema registra transacción de tipo "redeem"<br>8. El sistema decrementa stock de la recompensa<br>9. El sistema crea registro de canje<br>10. Si es cupón de descuento:<br>&nbsp;&nbsp;&nbsp;a. Genera código único (ej: LOY-ABC123)<br>&nbsp;&nbsp;&nbsp;b. Crea cupón en tabla discounts<br>&nbsp;&nbsp;&nbsp;c. Establece validez según configuración<br>&nbsp;&nbsp;&nbsp;d. Guarda código en el canje<br>11. El sistema confirma la transacción<br>12. El sistema muestra pantalla de éxito con:<br>&nbsp;&nbsp;&nbsp;- Mensaje de confirmación<br>&nbsp;&nbsp;&nbsp;- Código del cupón (grande, copiable)<br>&nbsp;&nbsp;&nbsp;- Fecha de expiración<br>&nbsp;&nbsp;&nbsp;- Instrucciones de uso<br>&nbsp;&nbsp;&nbsp;- Botón para ir al historial de canjes |
| **Flujos Alternativos**                  | **FA1: Puntos insuficientes**<br>- En paso 5 de canje, si puntos < costo<br>- El sistema muestra error "No tienes suficientes puntos"<br>- Indica cuántos puntos faltan<br>- Sugiere realizar compras<br>- Cancela el canje<br><br>**FA2: Nivel insuficiente**<br>- En paso 5 de canje, si nivel < nivel mínimo<br>- El sistema muestra error "Necesitas nivel X para esta recompensa"<br>- Muestra progreso al siguiente nivel<br>- Cancela el canje<br><br>**FA3: Sin stock**<br>- En paso 5 de canje, si stock = 0<br>- El sistema muestra error "Recompensa agotada"<br>- Sugiere otras recompensas similares<br>- Cancela el canje<br><br>**FA4: Puntos mínimos no alcanzados**<br>- Si puntos disponibles < min_points_to_redeem<br>- El sistema muestra error "Necesitas al menos X puntos para canjear"<br>- Muestra cuántos puntos faltan<br>- Cancela el canje<br><br>**FA5: Sin recompensas disponibles**<br>- Si no hay recompensas para el nivel del cliente<br>- Muestra mensaje "No hay recompensas disponibles para tu nivel"<br>- Muestra recompensas bloqueadas de niveles superiores<br>- Motiva a subir de nivel                                                                                                                                                                                                                                                                   |
| **Reglas de Negocio**                    | - Solo se muestran recompensas activas<br>- Solo se muestran recompensas del nivel del cliente o inferior<br>- El cliente debe tener puntos >= min_points_to_redeem<br>- El cliente debe tener puntos >= costo de la recompensa<br>- El stock se decrementa inmediatamente al canjear<br>- Los cupones tienen validez configurable (ej: 30-60 días)<br>- Los cupones son de un solo uso<br>- El código del cupón debe ser único<br>- La transacción es atómica (todo o nada)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **Requisitos Especiales**                | - El catálogo debe cargar en menos de 2 segundos<br>- Las imágenes deben estar optimizadas<br>- El botón "Canjear" debe deshabilitarse si no cumple requisitos<br>- El código del cupón debe ser fácil de copiar<br>- Debe haber confirmación antes de canjear<br>- Los errores deben ser claros y accionables                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **Información Adicional**                | **Tipos de Recompensas:**<br><br>**Descuento Porcentual:**<br>- Ejemplo: 10% de descuento<br>- Se aplica sobre el total de la compra<br>- Puede tener monto mínimo<br><br>**Descuento Fijo:**<br>- Ejemplo: $5 de descuento<br>- Se resta del total de la compra<br>- Puede tener monto mínimo<br><br>**Producto Gratis:**<br>- Ejemplo: Producto X gratis<br>- Se agrega al carrito sin costo<br>- Sujeto a disponibilidad<br><br>**Validez del Cupón:**<br>- Configurado en el sistema (30 días)<br>- Se muestra claramente al cliente<br>- Expira automáticamente<br><br>**Uso del Cupón:**<br>- Se aplica en el checkout<br>- Cliente ingresa el código<br>- Sistema valida y aplica descuento<br>- Cupón se marca como usado<br>- Ver CU-L05 para detalles                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
